<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Al Alamy Store | LAP ZONE</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070b18;
      --bg2:#0b1020;
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.20);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --shadow: 0 18px 65px rgba(0,0,0,.55);
      --r: 18px;
      --green:#22c55e;
      --green2:#0ea85f;
      --blue:#38bdf8;
      --cyan:#06b6d4;
      --amber:#f59e0b;
      --red:#ef4444;
      --max: 1220px;
      --grad: radial-gradient(1200px 600px at 10% -5%, rgba(34,197,94,.18), transparent 55%),
              radial-gradient(900px 500px at 95% 10%, rgba(56,189,248,.16), transparent 55%),
              radial-gradient(900px 500px at 50% 110%, rgba(245,158,11,.10), transparent 55%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--grad), linear-gradient(180deg,var(--bg),var(--bg2));
      overflow-x:hidden;
    }
    button{font-family:inherit}
    input,select,textarea{font-family:inherit}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(18px);
      background: rgba(8,12,26,.70);
      border-bottom:1px solid var(--stroke);
    }
    .topbar .wrap{
      max-width: var(--max);
      margin:0 auto;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .logo{
      width:46px; height:46px;
      border-radius: 16px;
      background: linear-gradient(145deg, rgba(34,197,94,.25), rgba(56,189,248,.15));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 38px rgba(0,0,0,.45);
      display:grid; place-items:center;
      position:relative; overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute; inset:-70%;
      background: conic-gradient(from 130deg,
        rgba(34,197,94,.0),
        rgba(34,197,94,.38),
        rgba(56,189,248,.22),
        rgba(34,197,94,.0)
      );
      animation: spin 7s linear infinite;
    }
    .logo span{ position:relative; font-weight:1000; letter-spacing:.4px; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .brand h1{ margin:0; font-size:14px; font-weight:1000; line-height:1.1; }
    .brand p{ margin:0; color:var(--muted); font-size:12px; line-height:1.2; }
    .top-actions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:flex; align-items:center; gap:10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--green);
      box-shadow: 0 0 0 6px rgba(34,197,94,.14);
    }
    .pill .txt{ color: var(--muted); font-size:12px; font-weight:800; white-space:nowrap; }
    .btn{
      border:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      color: var(--txt);
      font-weight:900;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: .12s ease;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: var(--stroke2); }
    .btn:active{ transform: translateY(0) scale(.98); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(14,168,95,.88));
      border-color: rgba(34,197,94,.35);
      color:#06120a;
      box-shadow: 0 18px 44px rgba(34,197,94,.18);
    }
    .btn.blue{
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(6,182,212,.88));
      border-color: rgba(56,189,248,.35);
      color:#061019;
      box-shadow: 0 18px 44px rgba(56,189,248,.16);
    }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size:12px; font-weight:1000; }

    .main{
      max-width: var(--max);
      margin: 16px auto 50px;
      padding: 0 16px;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap: 16px;
      align-items:start;
    }

    .sidebar{
      position:sticky;
      top: 78px;
      border-radius: var(--r);
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .side-head{
      padding: 14px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
    }
    .side-head .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .side-head h2{ margin:0; font-size:13px; font-weight:1000; }
    .side-head .sub{ margin-top:6px; color: var(--muted); font-size:12px; line-height:1.4; }
    .nav{ padding: 10px; display:grid; gap:10px; }
    .nav button{
      width:100%;
      text-align:right;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      color: var(--txt);
      cursor:pointer;
      transition: .12s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
      font-size:13px;
    }
    .nav button:hover{ background: rgba(255,255,255,.08); border-color: var(--stroke2); transform: translateY(-1px); }
    .nav button.active{
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(56,189,248,.10));
      border-color: rgba(34,197,94,.35);
    }
    .badge{
      font-size:11px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      color: var(--muted);
      white-space:nowrap;
      font-weight:1000;
    }
    .content{ display:grid; gap:16px; }
    .card{
      border-radius: var(--r);
      background: rgba(255,255,255,.055);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding: 14px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.045);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .card .head h3{ margin:0; font-size:14px; font-weight:1000; }
    .card .head .hint{ color: var(--muted); font-size:12px; font-weight:800; }
    .card .body{ padding:14px; }

    .grid2{ display:grid; grid-template-columns: 1.15fr .85fr; gap:16px; }
    .stats{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    .stat{
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      padding: 12px;
      min-height: 92px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stat .k{ color: var(--muted); font-size:12px; font-weight:900; }
    .stat .v{ font-size:18px; font-weight:1100; }
    .stat .s{ color: var(--muted2); font-size:12px; font-weight:800; }
    .divider{ height:1px; background: var(--stroke); margin: 10px 0; }

    .form{ display:grid; gap:12px; }
    .row4{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    .row3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:7px; }
    label{ color: var(--muted); font-size:12px; font-weight:1000; }
    .input, select, textarea{
      padding: 11px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      color: var(--txt);
      outline:none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    .input:focus, select:focus, textarea:focus{
      border-color: rgba(56,189,248,.45);
      box-shadow: 0 0 0 4px rgba(56,189,248,.10);
    }

    .list{ display:grid; gap:10px; }
    .item{
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--stroke);
      padding: 12px;
      display:grid;
      gap:10px;
    }
    .item .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .item h4{ margin:0; font-size:14px; font-weight:1100; line-height:1.3; }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color: var(--muted);
      font-size:12px;
      font-weight:900;
    }
    .tag{
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size:11px;
      font-weight:1000;
      white-space:nowrap;
    }
    .tag.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color: rgba(210,255,225,.92);}
    .tag.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color: rgba(255,240,210,.92);}
    .tag.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color: rgba(255,215,215,.92);}
    .actions{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .thumbs{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .thumb{
      width:52px; height:52px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      object-fit:cover;
      box-shadow: 0 12px 30px rgba(0,0,0,.30);
    }

    .kv{ display:grid; gap:10px; }
    .kv-row{
      display:grid;
      grid-template-columns: 1fr 1fr 44px;
      gap:10px;
      align-items:center;
    }
    .kv-row .del{
      height: 40px;
      border-radius: 14px;
      background: rgba(239,68,68,.14);
      border: 1px solid rgba(239,68,68,.25);
      color: rgba(255,255,255,.92);
      font-weight:1100;
      cursor:pointer;
    }
    .kv-row .del:hover{ background: rgba(239,68,68,.18); }

    .auth{
      max-width: 520px;
      margin: 70px auto;
      padding: 0 16px;
    }
    .auth .note{
      margin:0;
      color: var(--muted);
      font-size:12px;
      line-height:1.7;
    }
    .hide{ display:none !important; }
    canvas{ width:100% !important; height: 270px !important; }

    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; top:0; }
      .grid2{ grid-template-columns: 1fr; }
      .stats{ grid-template-columns: repeat(2, 1fr); }
      .row4{ grid-template-columns: repeat(2, 1fr); }
      .row3{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .stats{ grid-template-columns: 1fr; }
      .row4, .row3, .row2{ grid-template-columns: 1fr; }
      .brand p{ display:none; }
      .brand{ min-width:auto; }
    }
    /* ============================================================
   âœ… ADD-ON CSS (Paste at the END of your current CSS)
   Ù‡Ø¯ÙÙ‡: ØªØ­Ø³ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª + ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ + ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
   Ø¨Ø¯ÙˆÙ† ÙƒØ³Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ©
   ============================================================ */

/* ---------- 0) Global polish ---------- */
:root{
  --soft-glow: 0 18px 55px rgba(0,0,0,.45);
  --soft-glow-2: 0 22px 70px rgba(0,0,0,.55);
  --ring: 0 0 0 4px rgba(56,189,248,.14);
  --ring-green: 0 0 0 4px rgba(34,197,94,.14);
  --glass2: rgba(255,255,255,.075);
  --glass3: rgba(255,255,255,.095);
  --stroke3: rgba(255,255,255,.24);
}

/* smoother text rendering */
body{
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

/* ---------- 1) Orders / Products Cards: depth + hover ---------- */
#ordersList .item,
#productsList .item{
  position: relative;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
  border: 1px solid rgba(255,255,255,.11);
  box-shadow: var(--soft-glow);
  transition: transform .16s ease, border-color .16s ease, background .16s ease, box-shadow .16s ease;
  overflow: hidden;
}

#ordersList .item::before,
#productsList .item::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(900px 220px at 20% 0%, rgba(34,197,94,.10), transparent 60%),
    radial-gradient(900px 220px at 90% 10%, rgba(56,189,248,.12), transparent 60%),
    radial-gradient(800px 260px at 50% 120%, rgba(245,158,11,.08), transparent 60%);
  opacity: .65;
  pointer-events:none;
  z-index: 0;
}

#ordersList .item > *,
#productsList .item > *{
  position: relative;
  z-index: 1;
}

#ordersList .item:hover,
#productsList .item:hover{
  transform: translateY(-2px);
  border-color: rgba(255,255,255,.20);
  background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.05));
  box-shadow: var(--soft-glow-2);
}

#ordersList .item:active,
#productsList .item:active{
  transform: translateY(0) scale(.995);
}

/* ---------- 2) Stronger headings inside cards ---------- */
#ordersList .item h4,
#productsList .item h4{
  font-size: 15px;
  font-weight: 1100;
  letter-spacing: .1px;
  line-height: 1.35;
  margin-bottom: 6px;
}

/* subtle separator inside card blocks */
#ordersList .item .divider,
#productsList .item .divider{
  background: rgba(255,255,255,.10);
}

/* ---------- 3) Tags (status + meta) better readability ---------- */
#ordersList .tag,
#productsList .tag{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  color: rgba(255,255,255,.80);
  box-shadow: 0 10px 25px rgba(0,0,0,.18);
  transition: .16s ease;
}

#ordersList .tag.good,
#productsList .tag.good{
  background: rgba(34,197,94,.12);
  border-color: rgba(34,197,94,.30);
  color: rgba(225,255,236,.96);
}

#ordersList .tag.warn,
#productsList .tag.warn{
  background: rgba(245,158,11,.12);
  border-color: rgba(245,158,11,.30);
  color: rgba(255,245,225,.96);
}

#ordersList .tag.bad,
#productsList .tag.bad{
  background: rgba(239,68,68,.12);
  border-color: rgba(239,68,68,.30);
  color: rgba(255,228,228,.96);
}

/* make meta line wrap nicely */
#ordersList .meta,
#productsList .meta{
  gap: 8px 10px;
  line-height: 1.6;
}

/* ---------- 4) Orders details box (items) ---------- */
#ordersList pre{
  padding: 10px 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.045);
  border: 1px dashed rgba(255,255,255,.18);
  box-shadow: 0 12px 35px rgba(0,0,0,.22);
}

#ordersList .item .item{
  border-radius: 18px !important;
  background: rgba(255,255,255,.04) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
}

/* ---------- 5) Buttons inside cards (WhatsApp + edit) ---------- */
#ordersList .actions .btn,
#productsList .actions .btn{
  border-radius: 14px;
  padding: 9px 12px;
  font-weight: 1100;
  border-color: rgba(255,255,255,.14);
  background: rgba(255,255,255,.07);
  box-shadow: 0 14px 34px rgba(0,0,0,.22);
}

#ordersList .actions .btn:hover,
#productsList .actions .btn:hover{
  border-color: rgba(255,255,255,.22);
  background: rgba(255,255,255,.10);
}

/* optional: make primary buttons pop more */
#ordersList .btn.primary,
#productsList .btn.primary{
  box-shadow: 0 18px 45px rgba(34,197,94,.18);
}

#ordersList .btn.blue,
#productsList .btn.blue{
  box-shadow: 0 18px 45px rgba(56,189,248,.16);
}

/* ---------- 6) Status dropdown (select) nicer ---------- */
#ordersList select.input{
  min-height: 40px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(255,255,255,.07);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 12px 30px rgba(0,0,0,.20);
}

#ordersList select.input:focus{
  border-color: rgba(56,189,248,.45);
  box-shadow: var(--ring);
}

/* ---------- 7) Products thumbnails enhancement ---------- */
#productsList .thumbs{
  margin-top: 4px;
  gap: 10px;
}

#productsList .thumb{
  width: 56px;
  height: 56px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.04);
  transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
}

#productsList .thumb:hover{
  transform: translateY(-2px) scale(1.04);
  border-color: rgba(56,189,248,.28);
  box-shadow: 0 18px 44px rgba(0,0,0,.30);
}

/* ---------- 8) Product form look (if present on same page) ---------- */
.form .input,
.form select,
.form textarea{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.13);
}

.form .input:focus,
.form select:focus,
.form textarea:focus{
  box-shadow: var(--ring);
  border-color: rgba(56,189,248,.45);
}

.form textarea{
  line-height: 1.8;
}

/* emphasize profit field */
#p_profit{
  background: rgba(34,197,94,.08) !important;
  border-color: rgba(34,197,94,.22) !important;
  color: rgba(230,255,240,.96) !important;
}

/* ---------- 9) Filters bar spacing ---------- */
#tab-orders .row3,
#tab-products .row3{
  margin-bottom: 8px;
}

#tab-orders .row3 .field label,
#tab-products .row3 .field label{
  letter-spacing: .1px;
}

/* ---------- 10) Responsive boosts for mobile ---------- */
@media (max-width: 520px){
  #ordersList .item,
  #productsList .item{
    padding: 12px;
  }

  #ordersList .item .top,
  #productsList .item .top{
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  #ordersList .actions,
  #productsList .actions{
    justify-content: flex-start;
  }

  #ordersList select.input{
    width: 100%;
  }

  #productsList .thumb{
    width: 52px;
    height: 52px;
  }
}

/* ---------- 11) Make canceled orders look muted (optional visual) ---------- */
#ordersList .tag.bad{
  filter: saturate(1.05);
}

  </style>
</head>

<body>

<script>
/* =========================
   âœ… Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Supabase Ù‡Ù†Ø§ ÙÙ‚Ø·
   ========================= */
const SUPABASE_URL = "https://ojqlwvducojhpypfbwev.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_ZwJx3a8WsH6xiFZPm4oycA_nnoiKIYb";

/* =========================
   GLOBALS
   ========================= */
let supabaseClient = null;
let realtimeOn = false;
let realtimeChannel = null;

let PRODUCTS = [];
let ORDERS = [];
let editingProduct = null;

let chartStatus = null;
let chartSales = null;

const STATUS_AR = {
  new: "Ø¬Ø¯ÙŠØ¯",
  processing: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
  shipped: "ØªÙ… Ø§Ù„Ø´Ø­Ù†",
  done: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
  canceled: "Ù…Ù„ØºÙŠ"
};
const STATUS_ORDER = ["new","processing","shipped","done","canceled"];

const CATEGORY_OPTIONS = [
  { value:"offers", label:"ğŸ”¥ Ø§Ù„Ø¹Ø±ÙˆØ¶" },
  { value:"new-laptops", label:"ğŸ’» Ù„Ø§Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" },
  { value:"imported-laptops", label:"ğŸ“¦ Ù„Ø§Ø¨Ø§Øª Ø§Ø³ØªÙŠØ±Ø§Ø¯" },
  { value:"used-laptops", label:"ğŸ’» Ù„Ø§Ø¨Ø§Øª Ù…Ø³ØªØ¹Ù…Ù„Ø©" },
  { value:"used-phones", label:"ğŸ“± Ù‡ÙˆØ§ØªÙ Ù…Ø³ØªØ¹Ù…Ù„Ø©" },
  { value:"parts-accessories", label:"ğŸ§© Ù‚Ø·Ø¹ ØºÙŠØ§Ø± ÙˆØ¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª" }
];

const DEFAULT_TPLS = {
  shopName: "Al Alamy Store - LAP ZONE",
  confirm: `âœ… *ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ù…Ù† {shop}*\n\nğŸ§¾ *Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:* {order_number}\nğŸ‘¤ *Ø§Ù„Ø§Ø³Ù…:* {customer_name}\nğŸ“ *Ø§Ù„Ù‡Ø§ØªÙ:* {phone1}\nğŸ“ *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* {address}\n\nğŸ›’ *Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:*\n{items}\n\nğŸšš *Ø§Ù„Ø´Ø­Ù†:* {shipping} Ø¬.Ù…\nğŸ’° *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:* {total} Ø¬.Ù…\n\nğŸ“Œ Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´Ø­Ù†.\nğŸŒ ØªØ§Ø¨Ø¹ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±ÙˆØ¶: https://alalamylapzoon.github.io/lapzoon/#/`,
  shipped: `ğŸ“¦ *ØªÙ… Ø´Ø­Ù† Ø·Ù„Ø¨Ùƒ Ù…Ù† {shop}*\n\nğŸ§¾ *Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:* {order_number}\nğŸ‘¤ *Ø§Ù„Ø§Ø³Ù…:* {customer_name}\nğŸ“ *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* {address}\n\nâœ… Ø´ÙƒØ±Ù‹Ø§ Ù„Ø«Ù‚ØªÙƒ ÙÙŠÙ†Ø§ â€” Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„.\nğŸŒ Ø¹Ø±ÙˆØ¶Ù†Ø§ Ù…ØªØ§Ø­Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§: https://alalamylapzoon.github.io/lapzoon/#/`,
  thanks: `ğŸ¤ *Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø±Ùƒ {shop}*\n\nâœ… ØªÙ… ØªØ³Ù„ÙŠÙ… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.\nÙ„Ùˆ ÙÙŠ Ø£ÙŠ ØªÙ‚ÙŠÙŠÙ…/Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙ‡Ù…Ù†Ø§ Ø¬Ø¯Ù‹Ø§ Ù†Ø³Ù…Ø¹Ù‡Ø§ Ù…Ù†Ùƒ.\nğŸŒ Ø²ÙˆØ± Ù…ÙˆÙ‚Ø¹Ù†Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª: https://alalamylapzoon.github.io/lapzoon/#/`
};

function getTpls(){
  const raw = localStorage.getItem("LZ_TPLS_FINAL");
  if(!raw) return DEFAULT_TPLS;
  try{ return {...DEFAULT_TPLS, ...JSON.parse(raw)}; }catch(e){ return DEFAULT_TPLS; }
}
function saveTplsLocal(t){
  localStorage.setItem("LZ_TPLS_FINAL", JSON.stringify(t));
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function money(n){
  const x = Number(n||0);
  return x.toLocaleString("ar-EG");
}
function formatDate(ts){
  if(!ts) return "â€”";
  const d = new Date(ts);
  return d.toLocaleString("ar-EG", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}
function safeJson(v, fallback){
  if(v==null) return fallback;
  if(typeof v === "object") return v;
  try{ return JSON.parse(v); }catch(e){ return fallback; }
}
function parseNullableNumber(v){
  const t = String(v||"").trim();
  if(!t) return null;
  const n = Number(t);
  return isFinite(n) ? n : null;
}
function setConn(ok, msg){
  const dot = document.getElementById("connDot");
  const txt = document.getElementById("connTxt");
  dot.style.background = ok ? "var(--green)" : "var(--red)";
  dot.style.boxShadow = ok ? "0 0 0 6px rgba(34,197,94,.14)" : "0 0 0 6px rgba(239,68,68,.14)";
  txt.textContent = msg || (ok ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„");
}

/* =========================
   WhatsApp (Fixed)
   - ØªØ­ÙˆÙŠÙ„ Ø±Ù‚Ù… Ù…ØµØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ +20
   ========================= */
function normalizeEgyptPhone(phone){
  let p = String(phone||"").trim();
  if(!p) return "";
  p = p.replace(/[^\d+]/g, "");
  // Ù„Ùˆ Ø¨Ø¯Ø£ Ø¨Ù€ 0 => Ù†Ø­ÙˆÙ„Ù‡ +20xxxxxxxxxx
  if(p.startsWith("0")) p = "+20" + p.slice(1);
  // Ù„Ùˆ Ø¨Ø¯Ø£ Ø¨Ù€ 20 Ø¨Ø¯ÙˆÙ† +
  if(p.startsWith("20") && !p.startsWith("+")) p = "+" + p;
  return p;
}
function openWhatsApp(phone, message){
  const clean = normalizeEgyptPhone(phone);
  if(!clean) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ§Ù„Ø­");
  const url = "https://wa.me/" + clean.replace("+","") + "?text=" + encodeURIComponent(message);
  window.open(url, "_blank", "noopener,noreferrer");
}

function itemsToText(items){
  const arr = safeJson(items, []);
  if(!arr.length) return "â€”";
  return arr.map((it,i)=>{
    const name = it.name || it.title || ("Ù…Ù†ØªØ¬ " + (i+1));
    const qty = it.qty || it.quantity || 1;
    const price = it.price || it.unit_price || 0;
    return `â€¢ ${name} Ã— ${qty} â€” ${price} Ø¬.Ù…`;
  }).join("\n");
}

function buildMsg(tpl, order){
  const t = getTpls();
  const shop = t.shopName || DEFAULT_TPLS.shopName;

  return (tpl||"")
    .replaceAll("{shop}", shop)
    .replaceAll("{order_number}", order.order_number || "")
    .replaceAll("{customer_name}", order.customer_name || "")
    .replaceAll("{phone1}", order.phone1 || "")
    .replaceAll("{address}", order.address || "")
    .replaceAll("{shipping}", String(order.shipping || 0))
    .replaceAll("{total}", String(order.total || 0))
    .replaceAll("{items}", itemsToText(order.items));
}

function sendOrderWhatsApp(orderId, type){
  const o = ORDERS.find(x => String(x.order_id) === String(orderId));
  if(!o) return alert("Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const t = getTpls();
  const tpl = (type==="confirm") ? t.confirm : (type==="shipped") ? t.shipped : t.thanks;
  const msg = buildMsg(tpl, o);
  openWhatsApp(o.phone1, msg);
}

/* =========================
   AUTH
   ========================= */
async function initClient(){
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("PUT_YOUR_")){
    alert("Ø¶Ø¹ SUPABASE_URL Ùˆ SUPABASE_ANON_KEY Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹.");
    return null;
  }
  supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  return supabaseClient;
}
function authMsg(text){
  const el = document.getElementById("authMsg");
  el.style.display = "block";
  el.textContent = text;
}

async function login(){
  const email = (document.getElementById("email").value || "").trim();
  const password = (document.getElementById("password").value || "").trim();
  if(!email || !password) return authMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯.");

  await initClient();
  if(!supabaseClient) return;

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if(error) return authMsg("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);

  document.getElementById("authView").classList.add("hide");
  document.getElementById("appView").classList.remove("hide");
  onAuthed(data.user);
}

async function checkSessionAuto(){
  await initClient();
  if(!supabaseClient) return;

  const { data } = await supabaseClient.auth.getSession();
  if(data?.session?.user){
    document.getElementById("authView").classList.add("hide");
    document.getElementById("appView").classList.remove("hide");
    onAuthed(data.session.user);
  }
}

async function logout(){
  try{ await supabaseClient?.auth?.signOut(); }catch(e){}
  location.reload();
}

async function onAuthed(user){
  document.getElementById("userInfo").textContent = `Logged in: ${user.email}`;
  setConn(true, "Ù…ØªØµÙ„");
  initUI();
  await refreshAll();
  setupAuthListener();
}

function setupAuthListener(){
  supabaseClient.auth.onAuthStateChange((event, session)=>{
    if(!session?.user){
      location.reload();
    }
  });
}

/* =========================
   UI INIT
   ========================= */
function initUI(){
  setInterval(()=> document.getElementById("nowTxt").textContent = new Date().toLocaleString("ar-EG"), 1000);

  const catSelect = document.getElementById("p_category");
  catSelect.innerHTML = CATEGORY_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join("");

  const catFilter = document.getElementById("productCategoryFilter");
  catFilter.innerHTML = `<option value="">Ø§Ù„ÙƒÙ„</option>` + CATEGORY_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join("");

  addSpecRow("Ø§Ù„Ø´Ø§Ø´Ø©","60Hz");
  addGiftRow("Ø´Ù†Ø·Ø© Ù„Ø§Ø¨ØªÙˆØ¨ Ù‡Ø¯ÙŠØ©");

  ["p_cost","p_price"].forEach(id => document.getElementById(id).addEventListener("input", calcProfit));

  // Templates UI
  loadTemplatesUI();
}

/* =========================
   TABS
   ========================= */
let TAB = "dashboard";
function setTab(tab){
  TAB = tab;
  ["dashboard","products","orders","settings"].forEach(t=>{
    document.getElementById("tab-"+t).classList.toggle("hide", t!==tab);
    document.getElementById("tabBtn-"+t).classList.toggle("active", t===tab);
  });

  if(tab === "dashboard") renderDashboard();
  if(tab === "products") renderProducts();
  if(tab === "orders") renderOrders();
  if(tab === "settings") loadTemplatesUI();
}

/* =========================
   REALTIME (Optional)
   ========================= */
async function toggleRealtime(){
  realtimeOn = !realtimeOn;
  if(!realtimeOn){
    await stopRealtime();
    return alert("Realtime OFF âŒ");
  }
  await startRealtime();
  alert("Realtime ON âœ…");
}
async function startRealtime(){
  if(!supabaseClient) return;
  if(realtimeChannel) return;

  realtimeChannel = supabaseClient.channel("lz_admin_realtime_final");
  realtimeChannel
    .on("postgres_changes", { event: "*", schema: "public", table: "orders" }, () => loadOrders())
    .on("postgres_changes", { event: "*", schema: "public", table: "products" }, () => loadProducts());

  await realtimeChannel.subscribe();
}
async function stopRealtime(){
  if(!supabaseClient || !realtimeChannel) return;
  try{ await supabaseClient.removeChannel(realtimeChannel); }catch(e){}
  realtimeChannel = null;
}

/* =========================
   LOADERS
   ========================= */
async function refreshAll(){
  await Promise.all([loadProducts(), loadOrders()]);
  renderDashboard();
}

async function loadProducts(){
  const { data, error } = await supabaseClient
    .from("products")
    .select("*")
    .order("updated_at", { ascending: false });

  if(error){
    console.error(error);
    setConn(false,"Products Error");
    return alert("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: " + error.message);
  }

  PRODUCTS = data || [];
  document.getElementById("badgeProducts").textContent = PRODUCTS.length;
  document.getElementById("stProducts").textContent = PRODUCTS.length;
  document.getElementById("prodCountTag").textContent = PRODUCTS.length + " Ù…Ù†ØªØ¬";

  renderProducts();
  renderDashboard();
}

async function loadOrders(){
  const { data, error } = await supabaseClient
    .from("orders")
    .select("*");

  if(error){
    console.error(error);
    setConn(false,"Orders Error");
    return alert("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: " + error.message);
  }

  ORDERS = data || [];
  document.getElementById("badgeOrders").textContent = ORDERS.length;

  renderOrders();
  renderDashboard();
}

/* =========================
   DASHBOARD
   ========================= */
function getProductCost(p){
  if(p?.cost_price != null) return Number(p.cost_price);
  const specs = safeJson(p?.specifications, {});
  if(specs?.__cost_price != null) return Number(specs.__cost_price);
  if(specs?.["Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©"] != null) return Number(specs["Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©"]);
  return null;
}
function isCanceledHidden(o){
  if((o.status||"new") !== "canceled") return false;
  const show = document.getElementById("showCanceled")?.value || "hide";
  if(show === "show") return false;

  const t = new Date(o.updated_at || o.created_at || 0).getTime();
  const now = Date.now();
  const twoDays = 2*24*60*60*1000;
  return (now - t) > twoDays;
}
function countByStatus(status){
  return (ORDERS||[]).filter(o => (o.status||"new")===status && !isCanceledHidden(o)).length;
}
function sortOrdersForUI(arr){
  const list = [...(arr||[])].filter(o => !isCanceledHidden(o));
  const priority = (st)=> STATUS_ORDER.indexOf(st||"new");
  list.sort((a,b)=>{
    const pa = priority(a.status||"new");
    const pb = priority(b.status||"new");
    if(pa !== pb) return pa - pb;
    return new Date(b.created_at||0) - new Date(a.created_at||0);
  });
  return list;
}

function renderDashboard(){
  document.getElementById("stNew").textContent = countByStatus("new");
  document.getElementById("stProc").textContent = countByStatus("processing");
  document.getElementById("stShip").textContent = countByStatus("shipped");

  const latest = sortOrdersForUI(ORDERS).slice(0,6);
  const wrap = document.getElementById("latestOrders");
  wrap.innerHTML = latest.length ? "" : `<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div></div>`;

  latest.forEach(o=>{
    const st = o.status || "new";
    const tag = st==="new" ? "warn" : st==="processing" ? "good" : st==="shipped" ? "warn" : st==="done" ? "good" : "bad";
    wrap.innerHTML += `
      <div class="item">
        <div class="top">
          <div>
            <h4>${escapeHtml(o.customer_name)} â€” <span class="tag ${tag}">${STATUS_AR[st]||st}</span></h4>
            <div class="meta">
              <span class="tag"># ${escapeHtml(o.order_number)}</span>
              <span class="tag">ğŸ“… ${formatDate(o.created_at)}</span>
              <span class="tag">ğŸ’° ${money(o.total)} Ø¬.Ù…</span>
            </div>
          </div>
          <div class="actions">
            <button class="btn small blue" onclick="setTab('orders')">Ø¥Ø¯Ø§Ø±Ø©</button>
          </div>
        </div>
      </div>
    `;
  });

  let margins = [];
  for(const p of PRODUCTS){
    const price = Number(p.price||0);
    const cost = getProductCost(p);
    if(price>0 && cost!=null) margins.push(((price-cost)/price)*100);
  }
  const avg = margins.length ? (margins.reduce((a,b)=>a+b,0)/margins.length) : null;
  document.getElementById("stAvgMargin").textContent = avg==null ? "â€”" : (avg.toFixed(1) + "%");

  const now = Date.now();
  const d30 = 30*24*60*60*1000;
  const last30 = (ORDERS||[]).filter(o => (now - new Date(o.created_at||0).getTime()) <= d30);

  let profit = 0;
  for(const o of last30){
    const items = safeJson(o.items, []);
    for(const it of items){
      const qty = Number(it.qty || it.quantity || 1);
      const pid = it.id ?? it.product_id ?? it.productId;
      const price = Number(it.price || it.unit_price || 0);
      const p = PRODUCTS.find(x => x.id==pid || x.product_id==pid) || null;
      const cost = p ? getProductCost(p) : null;
      if(cost!=null) profit += (price - cost) * qty;
    }
  }
  document.getElementById("stProfit30").textContent = last30.length ? (money(profit) + " Ø¬.Ù…") : "â€”";

  renderCharts();
}

function renderCharts(){
  const labels = ["Ø¬Ø¯ÙŠØ¯","Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°","ØªÙ… Ø§Ù„Ø´Ø­Ù†","ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ù…Ù„ØºÙŠ"];
  const values = [
    countByStatus("new"),
    countByStatus("processing"),
    countByStatus("shipped"),
    countByStatus("done"),
    countByStatus("canceled")
  ];
  const ctx1 = document.getElementById("chartStatus");
  if(chartStatus) chartStatus.destroy();
  chartStatus = new Chart(ctx1, {
    type: "doughnut",
    data: { labels, datasets: [{ data: values }] },
    options: { responsive:true, plugins:{ legend:{ position:"bottom" } }, cutout:"60%" }
  });

  const days = 14;
  const byDay = new Map();
  for(let i=days-1;i>=0;i--){
    const d = new Date();
    d.setDate(d.getDate()-i);
    const key = d.toISOString().slice(0,10);
    byDay.set(key, 0);
  }
  for(const o of ORDERS||[]){
    const key = new Date(o.created_at||0).toISOString().slice(0,10);
    if(byDay.has(key)) byDay.set(key, byDay.get(key) + Number(o.total||0));
  }
  const labels2 = Array.from(byDay.keys()).map(k=>{
    const d = new Date(k);
    return d.toLocaleDateString("ar-EG", { month:"2-digit", day:"2-digit" });
  });
  const values2 = Array.from(byDay.values());

  const ctx2 = document.getElementById("chartSales");
  if(chartSales) chartSales.destroy();
  chartSales = new Chart(ctx2, {
    type: "line",
    data: { labels: labels2, datasets: [{ label:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", data: values2, tension:.35 }] },
    options: { responsive:true, plugins:{ legend:{ position:"bottom" } },
      scales: { y: { ticks: { callback: (v)=> v.toLocaleString("ar-EG") } } }
    }
  });
}

/* =========================
   PRODUCTS (unchanged core)
   ========================= */
function addSpecRow(k="", v=""){
  const wrap = document.getElementById("specsWrap");
  const row = document.createElement("div");
  row.className = "kv-row";
  row.innerHTML = `
    <input class="input spec-k" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§ØµÙØ©" value="${escapeHtml(k)}">
    <input class="input spec-v" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©" value="${escapeHtml(v)}">
    <button class="del" type="button">âœ–</button>
  `;
  row.querySelector(".del").onclick = ()=> row.remove();
  wrap.appendChild(row);
}
function collectSpecs(){
  const obj = {};
  document.querySelectorAll("#specsWrap .kv-row").forEach(r=>{
    const k = (r.querySelector(".spec-k")?.value || "").trim();
    const v = (r.querySelector(".spec-v")?.value || "").trim();
    if(k) obj[k] = v;
  });
  return obj;
}
function addGiftRow(text=""){
  const wrap = document.getElementById("giftsWrap");
  const row = document.createElement("div");
  row.className = "kv-row";
  row.innerHTML = `
    <input class="input gift-t" placeholder="Ø§Ù„Ù‡Ø¯ÙŠØ©" value="${escapeHtml(text)}">
    <div class="tag">Ø¹Ù†ØµØ±</div>
    <button class="del" type="button">âœ–</button>
  `;
  row.querySelector(".del").onclick = ()=> row.remove();
  wrap.appendChild(row);
}
function collectGifts(){
  const arr = [];
  document.querySelectorAll("#giftsWrap .kv-row").forEach(r=>{
    const t = (r.querySelector(".gift-t")?.value || "").trim();
    if(t) arr.push(t);
  });
  return arr;
}
function calcProfit(){
  const cost = Number(document.getElementById("p_cost").value || 0);
  const price = Number(document.getElementById("p_price").value || 0);
  const profit = price - cost;
  document.getElementById("p_profit").value = isFinite(profit) ? (money(profit) + " Ø¬.Ù…") : "â€”";
}

function resetProductForm(){
  editingProduct = null;
  document.getElementById("productModeHint").textContent = "ÙˆØ¶Ø¹: Ø¥Ø¶Ø§ÙØ©";
  document.getElementById("btnDeleteProduct").style.display = "none";

  ["p_id","p_name","p_price","p_cost","p_original","p_desc","p_details","p_img1","p_img2","p_img3","p_img4"].forEach(id=>{
    document.getElementById(id).value = "";
  });
  document.getElementById("p_category").value = CATEGORY_OPTIONS[0]?.value || "offers";
  document.getElementById("p_profit").value = "";

  document.getElementById("specsWrap").innerHTML = "";
  document.getElementById("giftsWrap").innerHTML = "";
  addSpecRow("Ø§Ù„Ø´Ø§Ø´Ø©","60Hz");
  addGiftRow("Ø´Ù†Ø·Ø© Ù„Ø§Ø¨ØªÙˆØ¨ Ù‡Ø¯ÙŠØ©");
}

function fillProductForm(p){
  editingProduct = p;
  document.getElementById("productModeHint").textContent = "ÙˆØ¶Ø¹: ØªØ¹Ø¯ÙŠÙ„";
  document.getElementById("btnDeleteProduct").style.display = "inline-flex";

  document.getElementById("p_id").value = p.id ?? "";
  document.getElementById("p_category").value = p.category ?? "offers";
  document.getElementById("p_name").value = p.name ?? "";
  document.getElementById("p_price").value = p.price ?? "";
  document.getElementById("p_original").value = p.original_price ?? "";
  document.getElementById("p_desc").value = p.description ?? "";
  document.getElementById("p_details").value = p.details ?? "";
  document.getElementById("p_img1").value = p.image1 ?? "";
  document.getElementById("p_img2").value = p.image2 ?? "";
  document.getElementById("p_img3").value = p.image3 ?? "";
  document.getElementById("p_img4").value = p.image4 ?? "";

  const cost = getProductCost(p);
  document.getElementById("p_cost").value = cost!=null ? cost : "";
  calcProfit();

  const specs = safeJson(p.specifications, {});
  document.getElementById("specsWrap").innerHTML = "";
  Object.keys(specs||{}).forEach(k=>{
    if(k === "__cost_price") return;
    addSpecRow(k, specs[k]);
  });

  const gifts = safeJson(p.gifts, []);
  document.getElementById("giftsWrap").innerHTML = "";
  (gifts||[]).forEach(g => addGiftRow(g));

  window.scrollTo({ top: 0, behavior:"smooth" });
}

async function saveProduct(){
  const payload = {
    id: parseNullableNumber(document.getElementById("p_id").value),
    category: (document.getElementById("p_category").value || "offers").trim(),
    name: (document.getElementById("p_name").value || "").trim(),
    description: (document.getElementById("p_desc").value || "").trim(),
    price: Number(document.getElementById("p_price").value || 0),
    original_price: parseNullableNumber(document.getElementById("p_original").value),
    image1: (document.getElementById("p_img1").value || "").trim(),
    image2: (document.getElementById("p_img2").value || "").trim(),
    image3: (document.getElementById("p_img3").value || "").trim(),
    image4: (document.getElementById("p_img4").value || "").trim(),
    details: (document.getElementById("p_details").value || "").trim(),
    specifications: collectSpecs(),
    gifts: collectGifts()
  };

  if(!payload.name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬");
  if(!payload.category) payload.category = "offers";

  const cost = parseNullableNumber(document.getElementById("p_cost").value);
  if(cost!=null){
    payload.cost_price = cost;
    payload.specifications = payload.specifications || {};
    payload.specifications["Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©"] = String(cost);
    payload.specifications["__cost_price"] = String(cost);
  }

  try{
    let res;
    if(payload.id != null){
      res = await supabaseClient.from("products").upsert(payload, { onConflict:"id" });
    }else{
      const p2 = {...payload}; delete p2.id;
      res = await supabaseClient.from("products").insert([p2]);
    }

    if(res.error){
      const msg = (res.error.message||"").toLowerCase();
      if(msg.includes("cost_price") && msg.includes("column")){
        const fixed = {...payload};
        delete fixed.cost_price;
        if(payload.id != null){
          const r2 = await supabaseClient.from("products").upsert(fixed, { onConflict:"id" });
          if(r2.error) throw r2.error;
        }else{
          const p2 = {...fixed}; delete p2.id;
          const r2 = await supabaseClient.from("products").insert([p2]);
          if(r2.error) throw r2.error;
        }
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… (cost_price ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â†’ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø¯Ø§Ø®Ù„ specifications)");
      }else{
        throw res.error;
      }
    }else{
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ âœ…");
    }

    await loadProducts();
    resetProductForm();
  }catch(e){
    console.error(e);
    alert("Ø®Ø·Ø£ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬: " + (e.message || e));
  }
}

async function deleteCurrentProduct(){
  if(!editingProduct) return;
  if(!confirm("Ù…ØªØ£ÙƒØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;

  const { error } = await supabaseClient
    .from("products")
    .delete()
    .eq("product_id", editingProduct.product_id);

  if(error) return alert("Ø®Ø·Ø£ Ø­Ø°Ù: " + error.message);

  alert("ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…");
  await loadProducts();
  resetProductForm();
}

function renderProducts(){
  const q = (document.getElementById("productSearch")?.value || "").trim().toLowerCase();
  const catF = (document.getElementById("productCategoryFilter")?.value || "").trim();
  const sort = document.getElementById("productSort")?.value || "new";

  let list = [...(PRODUCTS||[])];

  if(q){
    list = list.filter(p =>
      String(p.name||"").toLowerCase().includes(q) ||
      String(p.category||"").toLowerCase().includes(q)
    );
  }
  if(catF){
    list = list.filter(p => String(p.category||"") === catF);
  }

  if(sort === "price_high") list.sort((a,b)=> Number(b.price||0)-Number(a.price||0));
  if(sort === "price_low") list.sort((a,b)=> Number(a.price||0)-Number(b.price||0));
  if(sort === "name") list.sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "ar"));
  if(sort === "new") list.sort((a,b)=> new Date(b.updated_at||0)-new Date(a.updated_at||0));

  const wrap = document.getElementById("productsList");
  wrap.innerHTML = "";

  if(!list.length){
    wrap.innerHTML = `<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div></div>`;
    return;
  }

  for(const p of list){
    const imgs = [p.image1,p.image2,p.image3,p.image4].filter(Boolean);
    const cost = getProductCost(p);
    const profit = (cost!=null) ? (Number(p.price||0)-Number(cost||0)) : null;

    wrap.innerHTML += `
      <div class="item">
        <div class="top">
          <div>
            <h4>${escapeHtml(p.name)} <span class="tag">${escapeHtml(p.category||"offers")}</span></h4>
            <div class="meta">
              <span class="tag">ID: ${escapeHtml(p.id ?? "â€”")} â€¢ PID: ${escapeHtml(p.product_id ?? "â€”")}</span>
              <span class="tag">ğŸ’° ${money(p.price)} Ø¬.Ù…</span>
              <span class="tag">ğŸ•’ ${formatDate(p.updated_at)}</span>
              <span class="tag ${profit==null?'warn':(profit>=0?'good':'bad')}">
                ${profit==null ? "Ø±Ø¨Ø­: â€”" : ("Ø±Ø¨Ø­: "+money(profit)+" Ø¬.Ù…")}
              </span>
            </div>
          </div>
          <div class="actions">
            <button class="btn small blue" onclick="fillProductForm(PRODUCTS.find(x=>String(x.product_id)===String('${p.product_id}')))">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          </div>
        </div>

        ${imgs.length ? `
          <div class="thumbs">
            ${imgs.slice(0,4).map(u=> `<img class="thumb" src="${escapeHtml(u)}" onerror="this.style.display='none'">`).join("")}
          </div>
        ` : `<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</div>`}
      </div>
    `;
  }
}

/* =========================
   âœ… ORDERS (Fix Details + Status Dropdown + No Cancel Button)
   ========================= */
async function updateOrderStatus(order_id, newStatus){
  const { error } = await supabaseClient
    .from("orders")
    .update({ status: newStatus })
    .eq("order_id", order_id);

  if(error) return alert("Ø®Ø·Ø£ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©: " + error.message);
  await loadOrders();
}

function statusTagClass(st){
  return st==="new" ? "warn" : st==="processing" ? "good" : st==="shipped" ? "warn" : st==="done" ? "good" : "bad";
}

function actionButtonsForStatus(st){
  // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ÙŠ ØªØ¸Ù‡Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
  if(st === "new") return ["confirm"];
  if(st === "shipped") return ["shipped"];
  if(st === "done") return ["thanks"];
  return [];
}

function renderOrders(){
  const q = (document.getElementById("orderSearch")?.value || "").trim().toLowerCase();
  const stF = (document.getElementById("orderStatusFilter")?.value || "").trim();

  let list = sortOrdersForUI(ORDERS);

  if(q){
    list = list.filter(o =>
      String(o.customer_name||"").toLowerCase().includes(q) ||
      String(o.order_number||"").toLowerCase().includes(q) ||
      String(o.phone1||"").toLowerCase().includes(q) ||
      String(o.phone2||"").toLowerCase().includes(q)
    );
  }
  if(stF){
    list = list.filter(o => (o.status||"new") === stF);
  }

  const wrap = document.getElementById("ordersList");
  wrap.innerHTML = "";

  if(!list.length){
    wrap.innerHTML = `<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div></div>`;
    return;
  }

  for(const o of list){
    const st = o.status || "new";
    const btns = actionButtonsForStatus(st);

    // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
    const itemsArr = safeJson(o.items, []);
    const itemsText = itemsToText(itemsArr);
    const phone2 = o.phone2 ? ` â€¢ ${escapeHtml(o.phone2)}` : "";

    // Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    const gov = o.governorate ? escapeHtml(o.governorate) : "â€”";
    const area = o.area ? escapeHtml(o.area) : "â€”";
    const notes = o.notes ? escapeHtml(o.notes) : "â€”";

    const waBtns = btns.map(b=>{
      if(b==="confirm") return `<button class="btn small primary" type="button" onclick="sendOrderWhatsApp('${o.order_id}','confirm')">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</button>`;
      if(b==="shipped") return `<button class="btn small blue" type="button" onclick="sendOrderWhatsApp('${o.order_id}','shipped')">ğŸ“¦ ØªÙ… Ø§Ù„Ø´Ø­Ù†</button>`;
      if(b==="thanks") return `<button class="btn small" type="button" onclick="sendOrderWhatsApp('${o.order_id}','thanks')">ğŸ¤ Ø´ÙƒØ±</button>`;
      return "";
    }).join("");

    // Dropdown Ø§Ù„Ø­Ø§Ù„Ø§Øª
    const statusOptions = STATUS_ORDER.map(s=>{
      const sel = s===st ? "selected" : "";
      return `<option value="${s}" ${sel}>${STATUS_AR[s]||s}</option>`;
    }).join("");

    wrap.innerHTML += `
      <div class="item">
        <div class="top">
          <div>
            <h4>${escapeHtml(o.customer_name)} â€” <span class="tag ${statusTagClass(st)}">${STATUS_AR[st]||st}</span></h4>
            <div class="meta">
              <span class="tag"># ${escapeHtml(o.order_number)}</span>
              <span class="tag">ğŸ“… ${formatDate(o.created_at)}</span>
              <span class="tag">ğŸ’° ${money(o.total)} Ø¬.Ù…</span>
            </div>
          </div>

          <div class="actions">
            <span class="tag">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</span>
            <select class="input" style="min-width:170px" onchange="updateOrderStatus('${o.order_id}', this.value)">
              ${statusOptions}
            </select>
          </div>
        </div>

        <!-- âœ… ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø© Ø±Ø¬Ø¹Øª -->
        <div class="meta">
          <span class="tag">ğŸ“ ${escapeHtml(o.phone1 || "â€”")}${phone2}</span>
          <span class="tag">ğŸ“ ${gov} â€” ${area}</span>
          <span class="tag">ğŸ  ${escapeHtml(o.address||"â€”")}</span>
        </div>

        <div class="meta">
          <span class="tag">ğŸ§¾ Subtotal: ${money(o.subtotal||0)} Ø¬.Ù…</span>
          <span class="tag">ğŸšš Shipping: ${money(o.shipping||0)} Ø¬.Ù…</span>
          <span class="tag">ğŸ’° Total: ${money(o.total||0)} Ø¬.Ù…</span>
        </div>

        <div class="item" style="background:rgba(255,255,255,.03); border-color:rgba(255,255,255,.10)">
          <div class="meta" style="font-weight:1000; color:rgba(255,255,255,.86)">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
          <pre style="margin:0; white-space:pre-wrap; color:rgba(255,255,255,.86); font-family:inherit; line-height:1.8;">${escapeHtml(itemsText)}</pre>
        </div>

        <div class="meta">
          <span class="tag">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}</span>
        </div>

        <div class="actions">
          ${waBtns}
        </div>
      </div>
    `;
  }
}

/* =========================
   SETTINGS (Templates)
   ========================= */
function loadTemplatesUI(){
  const t = getTpls();
  document.getElementById("shopName").value = t.shopName;
  document.getElementById("tplConfirm").value = t.confirm;
  document.getElementById("tplShipped").value = t.shipped;
  document.getElementById("tplThanks").value = t.thanks;
}
function saveTemplates(){
  const t = {
    shopName: (document.getElementById("shopName").value||"").trim() || DEFAULT_TPLS.shopName,
    confirm: document.getElementById("tplConfirm").value,
    shipped: document.getElementById("tplShipped").value,
    thanks: document.getElementById("tplThanks").value,
  };
  saveTplsLocal(t);
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ âœ…");
}
function resetTemplates(){
  localStorage.removeItem("LZ_TPLS_FINAL");
  loadTemplatesUI();
  alert("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ âœ…");
}

/* =========================
   START
   ========================= */
window.addEventListener("load", async ()=>{
  await checkSessionAuto();
});
</script>

  <!-- ===== AUTH ===== -->
  <div class="auth" id="authView">
    <div class="card">
      <div class="head">
        <h3>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
        <div class="hint">Email / Password</div>
      </div>
      <div class="body">
        <p class="note">
          Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§Øª Supabase Auth.
        </p>

        <div class="divider"></div>

        <div class="form">
          <div class="row2">
            <div class="field">
              <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
              <input class="input" id="email" type="email" placeholder="admin@email.com" />
            </div>
            <div class="field">
              <label>Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</label>
              <input class="input" id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" type="button" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
          </div>

          <div class="divider"></div>
          <p class="note" id="authMsg" style="display:none;"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appView" class="hide">

    <div class="topbar">
      <div class="wrap">
        <div class="brand">
          <div class="logo"><span>LZ</span></div>
          <div>
            <h1>Al Alamy Store â€” LAP ZONE</h1>
            <p id="userInfo">Admin Dashboard â€¢ Supabase</p>
          </div>
        </div>

        <div class="top-actions">
          <div class="pill">
            <div class="dot" id="connDot"></div>
            <div class="txt" id="connTxt">Ù…ØªØµÙ„</div>
          </div>
          <button class="btn small" type="button" onclick="refreshAll()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn small blue" type="button" onclick="toggleRealtime()">ğŸŸ¢ Realtime</button>
          <button class="btn small" type="button" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </div>

    <div class="main">

      <aside class="sidebar">
        <div class="side-head">
          <div class="row">
            <h2>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
            <span class="badge" id="nowTxt">â€”</span>
          </div>
          <div class="sub">Dashboard + Products + Orders</div>
        </div>
        <div class="nav">
          <button id="tabBtn-dashboard" class="active" onclick="setTab('dashboard')">
            <span>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span><span class="badge">Charts</span>
          </button>
          <button id="tabBtn-products" onclick="setTab('products')">
            <span>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span><span class="badge" id="badgeProducts">0</span>
          </button>
          <button id="tabBtn-orders" onclick="setTab('orders')">
            <span>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span><span class="badge" id="badgeOrders">0</span>
          </button>
          <button id="tabBtn-settings" onclick="setTab('settings')">
            <span>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span><span class="badge">WhatsApp</span>
          </button>
        </div>
      </aside>

      <section class="content">

        <!-- Dashboard -->
        <div class="card" id="tab-dashboard">
          <div class="head">
            <h3>ğŸ“Š Dashboard â€” Ù…Ø®Ø·Ø·Ø§Øª ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
            <div class="hint">Ø¢Ø®Ø± 14 ÙŠÙˆÙ… + Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
          </div>
          <div class="body">
            <div class="stats">
              <div class="stat"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div><div class="v" id="stProducts">0</div><div class="s">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div></div>
              <div class="stat"><div class="k">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div><div class="v" id="stNew">0</div><div class="s">Ø¬Ø¯ÙŠØ¯</div></div>
              <div class="stat"><div class="k">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div><div class="v" id="stProc">0</div><div class="s">Processing</div></div>
              <div class="stat"><div class="k">ØªÙ… Ø§Ù„Ø´Ø­Ù†</div><div class="v" id="stShip">0</div><div class="s">Shipped</div></div>
            </div>

            <div class="divider"></div>

            <div class="grid2">
              <div class="card" style="box-shadow:none">
                <div class="head"><h3>ğŸ“Œ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><div class="hint">Donut</div></div>
                <div class="body"><canvas id="chartStatus"></canvas></div>
              </div>

              <div class="card" style="box-shadow:none">
                <div class="head"><h3>ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 14 ÙŠÙˆÙ…</h3><div class="hint">Line</div></div>
                <div class="body"><canvas id="chartSales"></canvas></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="grid2">
              <div class="card" style="box-shadow:none">
                <div class="head"><h3>ğŸ“¦ Ø£Ø­Ø¯Ø« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><div class="hint">Ø£Ø­Ø¯Ø« 6</div></div>
                <div class="body"><div class="list" id="latestOrders"></div></div>
              </div>

              <div class="card" style="box-shadow:none">
                <div class="head"><h3>ğŸ’¸ Ù…Ù„Ø®Øµ Ø§Ù„Ø±Ø¨Ø­</h3><div class="hint">ØªÙ‚Ø¯ÙŠØ±ÙŠ</div></div>
                <div class="body">
                  <div class="stats" style="grid-template-columns:1fr; gap:10px;">
                    <div class="stat"><div class="k">Ù…ØªÙˆØ³Ø· Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ (Ù…Ù†ØªØ¬Ø§Øª)</div><div class="v" id="stAvgMargin">â€”</div><div class="s">Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©</div></div>
                    <div class="stat"><div class="k">Ø±Ø¨Ø­ ØªÙ‚Ø¯ÙŠØ±ÙŠ (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)</div><div class="v" id="stProfit30">â€”</div><div class="s">Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div></div>
                  </div>
                  <div class="divider"></div>
                  <div class="actions">
                    <button class="btn primary" type="button" onclick="setTab('products')">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
                    <button class="btn blue" type="button" onclick="setTab('orders')">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Products -->
        <div class="card hide" id="tab-products">
          <div class="head">
            <h3>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„</h3>
            <div class="hint">Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© + Ù…ÙˆØ§ØµÙØ§Øª + ØªÙƒÙ„ÙØ© ÙˆØ±Ø¨Ø­</div>
          </div>
          <div class="body">

            <div class="card" style="box-shadow:none; margin-bottom:14px;">
              <div class="head">
                <h3>â• Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù†ØªØ¬</h3>
                <div class="hint" id="productModeHint">ÙˆØ¶Ø¹: Ø¥Ø¶Ø§ÙØ©</div>
              </div>
              <div class="body">

                <div class="form">
                  <div class="row4">
                    <div class="field">
                      <label>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ù†ØªØ¬ (id) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
                      <input class="input" id="p_id" type="number" placeholder="Ù…Ø«Ø§Ù„: 100" />
                    </div>
                    <div class="field">
                      <label>Ø§Ù„Ù‚Ø³Ù…</label>
                      <select id="p_category"></select>
                    </div>
                    <div class="field">
                      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                      <input class="input" id="p_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
                    </div>
                    <div class="field">
                      <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                      <input class="input" id="p_price" type="number" placeholder="Ù…Ø«Ø§Ù„: 350" />
                    </div>
                  </div>

                  <div class="row4">
                    <div class="field">
                      <label>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</label>
                      <input class="input" id="p_cost" type="number" placeholder="Ù…Ø«Ø§Ù„: 250" />
                    </div>
                    <div class="field">
                      <label>Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… (Original)</label>
                      <input class="input" id="p_original" type="number" placeholder="Ù…Ø«Ø§Ù„: 400" />
                    </div>
                    <div class="field">
                      <label>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                      <input class="input" id="p_profit" disabled placeholder="â€”" />
                    </div>
                    <div class="field">
                      <label>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­</label>
                      <button class="btn small" type="button" onclick="calcProfit()">ğŸ§® Ø§Ø­Ø³Ø¨</button>
                    </div>
                  </div>

                  <div class="row2">
                    <div class="field"><label>ÙˆØµÙ</label><textarea id="p_desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬â€¦"></textarea></div>
                    <div class="field"><label>ØªÙØ§ØµÙŠÙ„</label><textarea id="p_details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬â€¦"></textarea></div>
                  </div>

                  <div class="row4">
                    <div class="field"><label>Image 1</label><input class="input" id="p_img1" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© 1" /></div>
                    <div class="field"><label>Image 2</label><input class="input" id="p_img2" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© 2" /></div>
                    <div class="field"><label>Image 3</label><input class="input" id="p_img3" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© 3" /></div>
                    <div class="field"><label>Image 4</label><input class="input" id="p_img4" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© 4" /></div>
                  </div>

                  <div class="divider"></div>

                  <div class="grid2">
                    <div>
                      <div class="actions" style="justify-content:space-between;">
                        <div>
                          <div style="font-weight:1100;">ğŸ§¾ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ© (Key/Value)</div>
                          <div style="color:var(--muted); font-size:12px; font-weight:800; margin-top:4px;">Ù…Ø«Ø§Ù„: "Ø§Ù„Ø´Ø§Ø´Ø©" : "60Hz"</div>
                        </div>
                        <button class="btn small" type="button" onclick="addSpecRow()">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ©</button>
                      </div>
                      <div class="divider"></div>
                      <div class="kv" id="specsWrap"></div>
                    </div>

                    <div>
                      <div class="actions" style="justify-content:space-between;">
                        <div style="font-weight:1100;">ğŸ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</div>
                        <button class="btn small" type="button" onclick="addGiftRow('')">+ Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯ÙŠØ©</button>
                      </div>
                      <div class="divider"></div>
                      <div class="kv" id="giftsWrap"></div>
                    </div>
                  </div>

                  <div class="divider"></div>

                  <div class="actions">
                    <button class="btn primary" type="button" onclick="saveProduct()">ğŸ’¾ Ø­ÙØ¸</button>
                    <button class="btn" type="button" onclick="resetProductForm()">ğŸ§¹ ØªÙØ±ÙŠØº</button>
                    <button class="btn" id="btnDeleteProduct" style="display:none;" type="button" onclick="deleteCurrentProduct()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                  </div>
                </div>

              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="head">
                <h3>ğŸ“š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                <div class="hint"><span class="badge" id="prodCountTag">0</span></div>
              </div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>Ø¨Ø­Ø«</label><input class="input" id="productSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù…â€¦" oninput="renderProducts()" /></div>
                  <div class="field"><label>ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø³Ù…</label><select id="productCategoryFilter" onchange="renderProducts()"></select></div>
                  <div class="field">
                    <label>ØªØ±ØªÙŠØ¨</label>
                    <select id="productSort" onchange="renderProducts()">
                      <option value="new">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                      <option value="price_high">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø¹Ù„Ù‰</option>
                      <option value="price_low">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ù‚Ù„</option>
                      <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
                    </select>
                  </div>
                </div>

                <div class="divider"></div>
                <div class="list" id="productsList"></div>
              </div>
            </div>

          </div>
        </div>

        <!-- Orders -->
        <div class="card hide" id="tab-orders">
          <div class="head">
            <h3>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
            <div class="hint">Ø¬Ø¯ÙŠØ¯ â†’ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° â†’ ØªÙ… Ø§Ù„Ø´Ø­Ù† â†’ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… â†’ Ù…Ù„ØºÙŠ</div>
          </div>
          <div class="body">
            <div class="row3">
              <div class="field"><label>Ø¨Ø­Ø« (Ø§Ø³Ù… / Ø±Ù‚Ù… Ø·Ù„Ø¨ / Ù‡Ø§ØªÙ)</label><input class="input" id="orderSearch" placeholder="Ø§Ø¨Ø­Ø«â€¦" oninput="renderOrders()" /></div>
              <div class="field">
                <label>ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="orderStatusFilter" onchange="renderOrders()">
                  <option value="">Ø§Ù„ÙƒÙ„</option>
                  <option value="new">Ø¬Ø¯ÙŠØ¯</option>
                  <option value="processing">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                  <option value="shipped">ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
                  <option value="done">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                  <option value="canceled">Ù…Ù„ØºÙŠ</option>
                </select>
              </div>
              <div class="field">
                <label>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ØºÙŠ</label>
                <select id="showCanceled" onchange="renderOrders()">
                  <option value="hide">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù„ØºÙŠ Ø¨Ø¹Ø¯ ÙŠÙˆÙ…ÙŠÙ†</option>
                  <option value="show">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù„ØºÙŠ</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>
            <div class="list" id="ordersList"></div>
          </div>
        </div>

        <!-- Settings -->
        <div class="card hide" id="tab-settings">
          <div class="head">
            <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€” Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨</h3>
            <div class="hint">Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</div>
          </div>
          <div class="body">
            <div class="form">
              <div class="field">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</label>
                <input class="input" id="shopName" />
              </div>

              <div class="field">
                <label>Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (Ù„Ù„Ù€ Ø¬Ø¯ÙŠØ¯)</label>
                <textarea id="tplConfirm"></textarea>
              </div>

              <div class="field">
                <label>Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„Ø´Ø­Ù†</label>
                <textarea id="tplShipped"></textarea>
              </div>

              <div class="field">
                <label>Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
                <textarea id="tplThanks"></textarea>
              </div>

              <div class="actions">
                <button class="btn primary" type="button" onclick="saveTemplates()">ğŸ’¾ Ø­ÙØ¸</button>
                <button class="btn" type="button" onclick="resetTemplates()">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
              </div>

              <div style="color:var(--muted2); font-size:12px; font-weight:800; line-height:1.7;">
                Ù…ØªØºÙŠØ±Ø§Øª: <b>{order_number}</b> <b>{customer_name}</b> <b>{phone1}</b> <b>{address}</b> <b>{shipping}</b> <b>{total}</b> <b>{items}</b> <b>{shop}</b>
              </div>
            </div>
          </div>
        </div>

      </section>
    </div>
  </div>

<script>
/* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø£ÙˆÙ„ Ù…Ø±Ø© */
(function ensureTpls(){
  const raw = localStorage.getItem("LZ_TPLS_FINAL");
  if(!raw) saveTplsLocal(DEFAULT_TPLS);
})();
</script>
</body>
</html>
